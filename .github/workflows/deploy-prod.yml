name: Deploy TradeGate (Prod)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

# Important for private repos / least-privilege
permissions:
  contents: read

jobs:
  deploy:
    runs-on: [self-hosted, tradegate, prod]

    steps:
      - name: Configure git auth (HTTPS + GITHUB_TOKEN)
        shell: bash
        run: |
          set -euo pipefail
          cd /srv/tradegate/app

          # Force HTTPS remote with token (avoids SSH key issues)
          git remote set-url origin "https://x-access-token:${{ github.token }}@github.com/inkomati250/tradegate_site.git"

          # Optional sanity output (doesn't print token)
          git remote -v | sed -E 's#https://x-access-token:.*@github.com/#https://github.com/#'

      - name: Update code on VPS
        shell: bash
        run: |
          set -euo pipefail
          cd /srv/tradegate/app
          git fetch --all --prune
          git reset --hard origin/main

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          /srv/tradegate/venv/bin/pip install -r /srv/tradegate/app/requirements.txt

      - name: Django checks, migrate & collectstatic
        shell: bash
        run: |
          set -euo pipefail
          set -a; source /srv/tradegate/.env; set +a
          cd /srv/tradegate/app
          /srv/tradegate/venv/bin/python manage.py check --deploy
          /srv/tradegate/venv/bin/python manage.py migrate --noinput
          /srv/tradegate/venv/bin/python manage.py collectstatic --noinput

      - name: Restart services
        shell: bash
        run: |
          set -euo pipefail
          sudo -n /bin/systemctl restart tradegate
          sudo -n /bin/systemctl reload nginx

      - name: Show status (only if something fails)
        if: failure()
        shell: bash
        run: |
          sudo -n /bin/systemctl status tradegate --no-pager || true
          sudo -n /bin/systemctl status nginx --no-pager || true
          sudo journalctl -u tradegate -n 120 --no-pager || true
          sudo tail -n 120 /var/log/nginx/error.log || true

